<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Новинка</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="header">Останні новини</div>

<div class="menu">
    <a href="#" onclick="fetchNews()">Головна</a>
    <a href="#" onclick="fetchNews('Політика')">Політика</a>
    <a href="#" onclick="fetchNews('Суспільство')">Суспільство</a>
    <a href="#" onclick="fetchNews('Технології')">Технології</a>
    <a href="#" onclick="fetchNews('Спорт')">Спорт</a>
    
    <span id="admin-menu"></span>

    <form onsubmit="event.preventDefault(); fetchNews('', document.getElementById('search-input').value);" style="display:inline-block; margin-left:20px;">
        <input type="text" id="search-input" placeholder="Пошук..." required>
        <button type="submit">Знайти</button>
    </form>
</div>

<div class="wrapper">
    <div id="news-container">
        <p>Завантаження новин...</p>
    </div>
</div>

<script>
    // Оновлена функція fetchNews з підтримкою пошуку
    async function fetchNews(category = '', search = '') {
        const container = document.getElementById('news-container');
        container.innerHTML = '<p>Завантаження...</p>';

        try {
            // Побудова URL з параметрами пошуку та категорії
            let url = new URL('http://127.0.0.1:8000/api/news');
            if (category) url.searchParams.append('category', category);
            if (search) url.searchParams.append('search', search);

            const response = await fetch(url);
            const news = await response.json();

            // Заголовок результатів
            if (search) {
                container.innerHTML = `<h2>Результати пошуку: "${search}"</h2>`;
            } else if (category) {
                container.innerHTML = `<h2>Категорія: ${category}</h2>`;
            } else {
                container.innerHTML = '';
            }

            if (news.length === 0) {
                container.innerHTML += '<p>Новин не знайдено.</p>';
                return;
            }

            const isAdmin = localStorage.getItem('admin_token');

            news.forEach(item => {
                container.innerHTML += `
                    <div class="news-card">
                        ${item.image ? `<div class="news-image"><img src="http://127.0.0.1:8000/storage/${item.image}" alt="news"></div>` : ''}
                        <h2>${item.title}</h2>
                        <p class="category">${item.category} | ${new Date(item.created_at).toLocaleDateString()}</p>
                        <p>${item.short_text}</p>
                        <div class="card-actions">
                            <a class="btn" href="view.html?id=${item.id}">Читати далі</a>
                            ${isAdmin ? `
                                <button class="btn-delete" onclick="deleteNews(${item.id})" style="background:#ff4d4d; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;">Видалити</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        } catch (error) {
            container.innerHTML = '<p style="color:red">Помилка підключення до API. Перевірте "php artisan serve"</p>';
        }
    }

    // Логіка відображення меню авторизації
    function updateMenu() {
        const menuContainer = document.getElementById('admin-menu');
        const token = localStorage.getItem('admin_token');

        if (token) {
            menuContainer.innerHTML = `
                <a href="add.html" style="color: #4CAF50; font-weight: bold;">Додати новину</a>
                <a href="#" onclick="logout()" style="color: #ff4d4d;">Вихід (Адмін)</a>
            `;
        } else {
            menuContainer.innerHTML = `<a href="login.html">Увійти (Адмін)</a>`;
        }
    }

    // Функція виходу
    function logout() {
        localStorage.removeItem('admin_token');
        window.location.reload();
    }

    // Функція видалення (для адміна)
    async function deleteNews(id) {
        if (!confirm('Ви впевнені, що хочете видалити цю новину?')) return;

        const token = localStorage.getItem('admin_token');
        try {
            const response = await fetch(`http://127.0.0.1:8000/api/news/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            if (response.ok) {
                fetchNews(); // Оновлюємо список
            } else {
                alert('Помилка видалення. Можливо, сесія закінчилася.');
            }
        } catch (error) {
            alert('Помилка сервера');
        }
    }

    // Початкове завантаження
    updateMenu();
    fetchNews();
</script>
</body>
</html>